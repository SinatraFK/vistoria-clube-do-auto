<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clube do Auto - Avalia√ß√£o Comercial</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111827">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{--preto:#111827;--verde:#16a34a;--verde2:#22c55e;--cinza:#f2f4f7;--borda:#cfd4dc;--texto:#0b1220}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--cinza);margin:0;padding:14px;max-width:980px;margin-inline:auto;color:var(--texto)}
    .hidden{display:none !important}

    .topbar{display:flex;align-items:center;gap:14px;background:var(--preto);color:#fff;padding:12px;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.18);margin-bottom:12px}
    .topbar img{width:150px;height:auto;display:block}
    .topbarTitle{flex:1;display:flex;flex-direction:column;justify-content:center;gap:6px}
    .topbarTitle .main{font-weight:900;letter-spacing:.5px;font-size:18px}
    .userline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:12px;opacity:.95}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08)}
    .dot{width:10px;height:10px;border-radius:50%;background:#2e7d32}
    .btnSmall{border:none;border-radius:10px;padding:9px 11px;font-weight:900;cursor:pointer}
    .btnExit{background:var(--verde);color:#fff}
    .btnExit:hover{background:var(--verde2)}
    .btnGhost{background:rgba(255,255,255,.08);color:#fff}
    .btnGhost:hover{background:rgba(255,255,255,.14)}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .tabbtn{border:none;border-radius:12px;padding:11px 14px;font-weight:900;cursor:pointer;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.08);color:var(--preto)}
    .tabbtn.active{background:var(--verde);color:#fff}
    .tabbtn.active:hover{background:var(--verde2)}
    .tabbtn:hover{filter:brightness(.98)}

    .card{background:#fff;padding:14px;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.10);margin-bottom:14px}
    h3{margin:0 0 10px 0}
    label{font-weight:800;font-size:13px}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;margin-bottom:10px;border-radius:12px;border:1px solid var(--borda);font-size:15px;outline:none;background:#fff}
    textarea{resize:vertical;min-height:80px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:760px){.row2,.row3{grid-template-columns:1fr}}

    button{width:100%;padding:14px;border:none;border-radius:14px;font-size:16px;font-weight:900;cursor:pointer;margin-top:8px}
    .btnW{background:#25D366;color:#fff}
    .btnB{background:#1976d2;color:#fff}
    .btnG{background:#6b7280;color:#fff}
    .btnP{background:var(--verde);color:#fff}
    .btnP:hover{background:var(--verde2)}
    .hint{font-size:12px;color:#666;margin-top:-6px;margin-bottom:10px}
    .ok{color:#065f46;font-weight:900}
    .warn{color:#b91c1c;font-weight:900}
    .preview{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px;background:#fcfcfc;border:1px dashed #cfd4dc;padding:12px;border-radius:14px}

    /* Login */
    #screenLogin{display:block}
    .loginWrap{max-width:440px;margin:10vh auto 0 auto;background:#fff;padding:18px;border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .loginLogo{width:240px;display:block;margin:0 auto 14px auto}
    .loginTitle{margin:0;text-align:center;font-size:20px;font-weight:900;color:var(--preto)}
    .loginSubtitle{margin:10px 0 16px 0;text-align:center;color:#6b7280}
    .loginBtns{display:grid;grid-template-columns:1fr;gap:10px;margin-top:6px}
    .loginRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.loginRow{grid-template-columns:1fr}}

    /* Hist√≥rico */
    .histItem{border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin-bottom:10px;background:#fafafa}
    .histTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .histTitle{font-weight:900}
    .histMeta{font-size:12px;color:#666;margin-top:4px}
    .histBtns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    @media (max-width:760px){.histBtns{grid-template-columns:1fr 1fr}}
    .mini{padding:10px;border-radius:12px;font-size:13px;font-weight:900;color:#fff;border:none;cursor:pointer}
    .mOpen{background:#111827}
    .mCopy{background:#1976d2}
    .mSend{background:#25D366}
  </style>
</head>

<body>

<!-- LOGIN -->
<section id="screenLogin">
  <div class="loginWrap">
    <img src="logo.png" class="loginLogo" alt="Logo Clube do Auto"
      onerror="this.style.display='none'; alert('Logo n√£o encontrada. Verifique se o arquivo se chama logo.png e est√° na mesma pasta do index.html');">
    <div class="loginTitle">AVALIA√á√ÉO COMERCIAL</div>
    <div class="loginSubtitle">Entre para salvar na nuvem. Hist√≥rico (por enquanto) somente admins.</div>

    <div class="loginRow">
      <div>
        <label>E-mail</label>
        <input id="loginEmail" inputmode="email" placeholder="ex: gerente@clube.com">
      </div>
      <div>
        <label>Senha</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
    </div>

    <div class="loginBtns">
      <button class="btnP" id="btnDoLogin">Entrar</button>
      <button class="btnG" id="btnCreateUser">Cadastrar</button>
      <button class="btnB" id="btnGuest">Convidado</button>
    </div>

    <div class="hint" id="loginHint" style="margin-top:12px"></div>
  </div>
</section>

<!-- APP -->
<section id="screenApp" class="hidden">
  <div class="topbar">
    <img src="logo.png" alt="Logo Clube do Auto">
    <div class="topbarTitle">
      <div class="main">AVALIA√á√ÉO COMERCIAL</div>
      <div class="userline">
        <span class="chip"><span class="dot" id="dot"></span><span id="statusTxt">APROVADO</span></span>
        <span class="chip" id="whoami">‚Äî</span>
      </div>
    </div>
    <button class="btnSmall btnGhost" id="btnSwitchUser">Trocar usu√°rio</button>
    <button class="btnSmall btnExit" id="btnLogout">Sair</button>
  </div>

  <div class="tabs">
    <button class="tabbtn active" id="tabNova">Nova avalia√ß√£o</button>
    <button class="tabbtn" id="tabHist">Hist√≥rico</button>
  </div>

  <!-- NOVA -->
  <div id="viewNova">
    <div class="card">
      <h3>üöó Ve√≠culo</h3>
      <label>Modelo <span class="hint">(obrigat√≥rio)</span></label>
      <input id="modelo" placeholder="Ex: Fox Trend">

      <div class="row2">
        <div><label>Ano <span class="hint">(obrigat√≥rio)</span></label><input id="ano" placeholder="Ex: 2012/2013"></div>
        <div>
          <label>Vers√£o <span class="hint">(obrigat√≥rio)</span></label>
          <select id="versao">
            <option value="">Selecione</option>
            <option>B√°sico</option>
            <option>Completo</option>
            <option>Completo menos ar</option>
            <option>Completo + 7 Lugares</option>
            <option>Apenas Vidros El√©tricos</option>
            <option>Apenas dire√ß√£o</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div><label>Placa <span class="hint">(obrigat√≥rio)</span></label><input id="placa" placeholder="Ex: EPX5C99"></div>
        <div><label>Km <span class="hint">(obrigat√≥rio)</span></label><input id="km" placeholder="Ex: 237.568"></div>
        <div><label>Comprou (Km) <span class="hint">(obrigat√≥rio)</span></label><input id="kmComprou" placeholder="Ex: 185.975"></div>
      </div>
    </div>

    <div class="card">
      <h3>üí∞ Neg√≥cio</h3>
      <div class="row2">
        <div>
          <label>Fipe <span class="hint">(obrigat√≥rio)</span></label>
          <input id="fipe" inputmode="decimal" placeholder="Ex: 32.500">
          <div class="hint">No relat√≥rio sai como: R$ 32.500</div>
        </div>
        <div>
          <label>Valor pretendido</label>
          <input id="valorPretendido" inputmode="decimal" placeholder="Ex: 29.900">
          <div class="hint">No relat√≥rio sai como: R$ 29.900</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>üìã Laudo (Estrutural)</h3>
      <label>Status</label>
      <select id="laudo">
        <option>APROVADO</option>
        <option>APONTAMENTO</option>
        <option>REPROVADO</option>
      </select>

      <div id="laudoObsWrap">
        <label>Descri√ß√£o do laudo <span class="hint">(obrigat√≥rio apenas em Apontamento/Reprovado)</span></label>
        <textarea id="laudoObs" placeholder="Longarina, painel, colunas, chassi..."></textarea>
      </div>

      <h3 style="margin-top:14px">üö® Leil√£o</h3>
      <label>Situa√ß√£o</label>
      <select id="leilao">
        <option>N√£o</option>
        <option>Financeira</option>
        <option>Pequena monta</option>
        <option>M√©dia monta</option>
      </select>
      <div class="hint">S√≥ aparece no relat√≥rio se n√£o for ‚ÄúN√£o‚Äù.</div>
    </div>

    <div class="card">
      <h3>‚öôÔ∏è Gastos / Condi√ß√£o Geral</h3>

      <label>Motor (texto livre)</label>
      <textarea id="motor" placeholder="Batendo, rajando, fumando..."></textarea>

      <label>Luzes do painel (texto livre)</label>
      <textarea id="luzes" placeholder="Inje√ß√£o, √≥leo, ABS..."></textarea>

      <label>Ar-condicionado</label>
      <select id="ar">
        <option>Bom</option>
        <option>N√£o gela</option>
        <option>N√£o funciona</option>
        <option>N√£o possui</option>
      </select>

      <h3 style="margin-top:14px">Interna</h3>
      <div class="row3">
        <div><label>Volante</label><select id="volante"><option>Bom</option><option>Encapar</option><option>Reformar</option></select></div>
        <div><label>Manopla do c√¢mbio</label><select id="cambio"><option>Bom</option><option>Trocar</option></select></div>
        <div><label>Console central</label><select id="console"><option>Bom</option><option>Reparar</option><option>Trocar</option></select></div>
      </div>

      <div class="row2">
        <div><label>Bancos (onde)</label><select id="bancosOnde"><option value="">‚Äî</option><option>Motorista</option><option>Dianteiros</option><option>Traseiro</option><option>Todos</option></select></div>
        <div><label>Bancos (a√ß√£o)</label><select id="bancosAcao"><option value="">‚Äî</option><option>Faixa</option><option>Reforma</option><option>Troca</option></select></div>
      </div>
      <label>Obs. bancos (ex: 7 pe√ßas / rasgos / espuma)</label>
      <input id="bancosObs" placeholder="Ex: Faixa bancos 7 pe√ßas">

      <h3 style="margin-top:14px">Externa</h3>
      <div class="row3">
        <div>
          <label>Pe√ßas para pintar</label>
          <select id="pecasPintura">
            <option value="0">0</option><option value="1">1 pe√ßa</option><option value="2">2 pe√ßas</option><option value="3">3 pe√ßas</option>
            <option value="4">4 pe√ßas</option><option value="5">5 pe√ßas</option><option value="6">6 pe√ßas</option><option value="7">7 pe√ßas</option>
            <option value="8">8 pe√ßas</option><option value="9">9 pe√ßas</option><option value="10">10 pe√ßas</option><option value="11">11 pe√ßas</option>
            <option value="12">12 pe√ßas</option><option value="completa">Pintura completa</option>
          </select>
        </div>
        <div><label>Far√≥is (E)</label><select id="farolE"><option>Bom</option><option>Polimento</option><option>Troca</option></select></div>
        <div><label>Far√≥is (D)</label><select id="farolD"><option>Bom</option><option>Polimento</option><option>Troca</option></select></div>
      </div>

      <div class="row3">
        <div><label>Lanternas (E)</label><select id="lanternaE"><option>Bom</option><option>Polimento</option><option>Troca</option></select></div>
        <div><label>Lanternas (D)</label><select id="lanternaD"><option>Bom</option><option>Polimento</option><option>Troca</option></select></div>
        <div><label>Pneus avariados</label><select id="pneus"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
      </div>

      <label>Outros gastos (texto livre)</label>
      <textarea id="outros" placeholder="Ex: Terminal de dire√ß√£o, revisar vidros el√©tricos, travas..."></textarea>

      <div class="hint">No relat√≥rio aparecem apenas itens que geram custo.</div>
    </div>

    <div class="card">
      <h3>üë®‚Äçüîß Respons√°veis</h3>
      <div class="row2">
        <div><label>Consultor <span class="hint">(obrigat√≥rio)</span></label><input id="consultor" placeholder="Ex: Will"></div>
        <div><label>Avaliadores <span class="hint">(obrigat√≥rio)</span></label><input id="avaliadores" placeholder="Ex: Junior / Lucas / Guilherme"></div>
      </div>
    </div>

    <div class="card">
      <h3>üë§ Cliente</h3>
      <div class="row2">
        <div><label>Cliente <span class="hint">(obrigat√≥rio)</span></label><input id="cliente" placeholder="Nome do cliente"></div>
        <div><label>Local</label><input id="local" placeholder="Ex: Osasco / SP"></div>
      </div>
      <label>Capta√ß√£o</label>
      <select id="captacao">
        <option value="">Selecione</option>
        <option>Lead</option>
        <option>Porta</option>
        <option>Org√¢nico</option>
      </select>
      <div class="hint">‚ÄúOsasco - SP üìç‚Äù sempre aparece no relat√≥rio.</div>
    </div>

    <div class="card">
      <h3>‚úÖ Finalizar</h3>
      <button class="btnW" id="btnWhats">üì≤ Enviar relat√≥rio (WhatsApp)</button>
      <button class="btnB" id="btnCopy">üìã Copiar relat√≥rio</button>

      <h3 style="margin-top:14px;">Pr√©via do relat√≥rio</h3>
      <div class="preview" id="preview"></div>
      <div class="hint" id="saveHint" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- HIST√ìRICO -->
  <div id="viewHistorico" class="hidden">
    <div class="card">
      <h3>‚òÅÔ∏è Hist√≥rico na Nuvem</h3>
      <div class="hint" id="histHint"></div>
      <div style="height:10px"></div>
      <div id="historicoList"></div>
    </div>
  </div>
</section>

<textarea id="copyFallback" style="position:fixed;left:-9999px;top:-9999px;"></textarea>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signOut, setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== Firebase config =====
  const firebaseConfig = {
    apiKey: "AIzaSyCvn2_z1FN2XMN_pgR9IiExRkRNMgZfhIY",
    authDomain: "clube-do-auto.firebaseapp.com",
    projectId: "clube-do-auto",
    appId: "1:647571720442:web:4257dd525b59bd89b62143"
  };

  // ===== Admins fixos (hist√≥rico liberado) =====
  const HARD_ADMINS = new Set([
    "admin@clubedoauto.com",
    "frank.since96@gmail.com"
  ].map(s => s.toLowerCase()));

  // ===== Helpers =====
  const el = (id) => document.getElementById(id);
  const v = (id) => (el(id).value ?? "").toString().trim();
  const lower = (s) => (s ?? "").toString().trim().toLowerCase();

  function showLogin(){
    el("screenLogin").style.display = "block";
    el("screenApp").classList.add("hidden");
  }
  function showApp(){
    el("screenLogin").style.display = "none";
    el("screenApp").classList.remove("hidden");
  }

  // PWA SW (opcional)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }

  // Firebase init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await setPersistence(auth, browserLocalPersistence);

  let isGuest = false;
  let unsubHist = null;

  // Tabs
  function setTab(tab){
    const novaOn = (tab==="nova");
    el("tabNova").classList.toggle("active", novaOn);
    el("tabHist").classList.toggle("active", !novaOn);
    el("viewNova").classList.toggle("hidden", !novaOn);
    el("viewHistorico").classList.toggle("hidden", novaOn);

    if(!novaOn) openHistorico();
  }
  el("tabNova").addEventListener("click", ()=>setTab("nova"));
  el("tabHist").addEventListener("click", ()=>setTab("hist"));

  // Status badge
  function setStatusBadge(){
    const s = (v("laudo") || "APROVADO").toUpperCase();
    el("statusTxt").innerText = s;
    el("dot").style.background =
      (s === "REPROVADO") ? "#d32f2f" :
      (s === "APONTAMENTO") ? "#f9a825" :
      "#2e7d32";
  }
  function toggleLaudoDescricao(){
    const s = (v("laudo") || "APROVADO").toUpperCase();
    if(s === "APROVADO"){
      el("laudoObsWrap").style.display = "none";
      el("laudoObs").value = "";
    }else{
      el("laudoObsWrap").style.display = "block";
    }
  }

  function focusWarn(id, msg){
    alert(msg);
    const e = el(id);
    if(e){ e.focus(); e.scrollIntoView({behavior:"smooth", block:"center"}); }
    return false;
  }

  function validarObrigatorios(){
    if(!v("modelo")) return focusWarn("modelo","Campo obrigat√≥rio: Modelo");
    if(!v("ano")) return focusWarn("ano","Campo obrigat√≥rio: Ano");
    if(!v("versao")) return focusWarn("versao","Campo obrigat√≥rio: Vers√£o");
    if(!v("placa")) return focusWarn("placa","Campo obrigat√≥rio: Placa");
    if(!v("km")) return focusWarn("km","Campo obrigat√≥rio: Km");
    if(!v("kmComprou")) return focusWarn("kmComprou","Campo obrigat√≥rio: Comprou (Km)");
    if(!v("fipe")) return focusWarn("fipe","Campo obrigat√≥rio: Fipe");

    const s = (v("laudo") || "APROVADO").toUpperCase();
    if(s !== "APROVADO" && !v("laudoObs")) return focusWarn("laudoObs","Descreva o laudo em Apontamento/Reprovado.");

    if(!v("consultor")) return focusWarn("consultor","Campo obrigat√≥rio: Consultor");
    if(!v("avaliadores")) return focusWarn("avaliadores","Campo obrigat√≥rio: Avaliadores");
    if(!v("cliente")) return focusWarn("cliente","Campo obrigat√≥rio: Cliente");
    return true;
  }

  function fmtBRL(raw){ const s=(raw||"").trim(); return s?("R$ "+s):""; }
  function b(label, value){ return value ? (`*${label}:* ${value}`) : ""; }

  function montarRelatorio(){
    const laudo = (v("laudo") || "APROVADO").toUpperCase();
    const icone = (laudo==="REPROVADO") ? "üî¥" : (laudo==="APONTAMENTO") ? "üü°" : "üü¢";

    let r = "";
    r += b("Modelo", v("modelo"));
    r += "\n\n" + b("Ano", v("ano"));
    r += "\n\n" + b("Vers√£o", v("versao"));
    r += "\n\n" + b("Placa", v("placa"));
    r += "\n\n" + b("Km", v("km"));
    r += "\n" + b("Comprou", v("kmComprou"));

    r += "\n\nüìä *Fipe:* " + fmtBRL(v("fipe"));
    if(v("valorPretendido")) r += "\n" + b("Valor pretendido", fmtBRL(v("valorPretendido")));

    r += "\n\nüìã *Laudo*";
    r += "\n" + icone + " " + laudo;
    if(laudo !== "APROVADO" && v("laudoObs")) r += "\n" + v("laudoObs");

    const leilao = v("leilao");
    if(leilao && leilao.toLowerCase() !== "n√£o"){
      r += "\n\nüö® *Leil√£o:* " + leilao;
    }

    const gastos = [];
    if(v("motor")) gastos.push("Motor: " + v("motor"));
    if(v("luzes")) gastos.push("Luzes do painel: " + v("luzes"));

    const ar = v("ar");
    if(ar && ar !== "Bom" && ar !== "N√£o possui") gastos.push("Ar-condicionado: " + ar);

    if(v("volante") !== "Bom") gastos.push("Volante: " + v("volante"));
    if(v("cambio") !== "Bom") gastos.push("Manopla do c√¢mbio: " + v("cambio"));
    if(v("console") !== "Bom") gastos.push("Console central: " + v("console"));

    const bancosOnde = v("bancosOnde");
    const bancosAcao = v("bancosAcao");
    if(bancosOnde && bancosAcao){
      let line = `Bancos (${bancosOnde}): ${bancosAcao}`;
      if(v("bancosObs")) line += ` (${v("bancosObs")})`;
      gastos.push(line);
    }else if(v("bancosObs")){
      gastos.push("Bancos: " + v("bancosObs"));
    }

    const pecas = v("pecasPintura");
    if(pecas && pecas !== "0"){
      if(pecas === "completa") gastos.push("Pintura: completa");
      else gastos.push(`Pintura: ${pecas} pe√ßa(s)`);
    }

    if(v("farolE") !== "Bom") gastos.push(`Farol esquerdo: ${v("farolE")}`);
    if(v("farolD") !== "Bom") gastos.push(`Farol direito: ${v("farolD")}`);
    if(v("lanternaE") !== "Bom") gastos.push(`Lanterna esquerda: ${v("lanternaE")}`);
    if(v("lanternaD") !== "Bom") gastos.push(`Lanterna direita: ${v("lanternaD")}`);

    const pneus = v("pneus");
    if(pneus && pneus !== "0") gastos.push(`Pneus avariados: ${pneus}`);

    if(v("outros")) gastos.push("Outros: " + v("outros"));

    if(gastos.length) r += "\n\n‚öôÔ∏è Gastos\n" + gastos.join("\n");

    r += "\n\n" + b("Consultor", v("consultor"));
    r += "\n" + b("Avaliadores", v("avaliadores"));
    r += "\n\n" + b("Cliente", v("cliente"));
    if(v("local")) r += "\n" + b("Local", v("local"));
    if(v("captacao")) r += "\n" + b("Capta√ß√£o", v("captacao"));
    r += "\n\nOsasco - SP üìç";

    return r.trim();
  }

  function atualizarPreview(){
    el("preview").innerText = montarRelatorio();
  }

  async function copiarTexto(texto){
    if(navigator.clipboard?.writeText){
      try{ await navigator.clipboard.writeText(texto); return true; }catch(e){}
    }
    const ta = el("copyFallback");
    ta.value = texto; ta.focus(); ta.select();
    try{
      const ok = document.execCommand("copy");
      if(ok) return true;
    }catch(e){}
    window.prompt("Copie o relat√≥rio abaixo:", texto);
    return false;
  }

  function abrirWhats(texto){
    const enc = encodeURIComponent(texto);
    const url = "https://wa.me/?text=" + enc; // abre o seletor/√∫ltimo contato no WhatsApp
    const a = document.createElement("a");
    a.href = url;
    a.target = "_blank";
    a.rel = "noopener";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  async function salvarNoFirestore(texto){
    if(isGuest) return;
    const u = auth.currentUser;
    if(!u) return;

    try{
      await addDoc(collection(db, "vistorias"), {
        createdAt: serverTimestamp(),
        createdByEmail: lower(u.email || ""),
        modelo: v("modelo"),
        placa: v("placa"),
        laudo: (v("laudo")||"APROVADO").toUpperCase(),
        reportText: texto
      });
      el("saveHint").innerHTML = "<span class='ok'>Salvo na nuvem.</span>";
    }catch(e){
      el("saveHint").innerHTML = "<span class='warn'>Falha ao salvar:</span> " + (e?.message || e);
    }
  }

  function formatDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : null;
      if(!d) return "";
      return new Intl.DateTimeFormat("pt-BR", {day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(d);
    }catch(e){ return ""; }
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function openHistorico(){
    el("historicoList").innerHTML = "";
    el("histHint").innerHTML = "";

    if(isGuest){
      el("histHint").innerHTML = "<span class='warn'>Convidado n√£o tem hist√≥rico.</span>";
      el("historicoList").innerHTML = "<div class='histItem'><b>Fa√ßa login para usar hist√≥rico.</b></div>";
      return;
    }

    const u = auth.currentUser;
    if(!u){
      el("histHint").innerHTML = "<span class='warn'>Voc√™ precisa estar logado.</span>";
      el("historicoList").innerHTML = "<div class='histItem'><b>Fa√ßa login.</b></div>";
      return;
    }

    const email = lower(u.email || "");
    const isAdmin = HARD_ADMINS.has(email);
    if(!isAdmin){
      el("histHint").innerHTML = "<span class='warn'>Hist√≥rico (temporariamente) apenas para admins.</span>";
      el("historicoList").innerHTML = "<div class='histItem'><b>Solicite ao admin para liberar na pr√≥xima vers√£o.</b></div>";
      return;
    }

    el("histHint").innerHTML = "<span class='ok'>Admin:</span> mostrando √∫ltimas 200 avalia√ß√µes (nuvem).";

    if(unsubHist) unsubHist();
    const qy = query(collection(db, "vistorias"), orderBy("createdAt","desc"), limit(200));
    unsubHist = onSnapshot(qy, (snap)=>{
      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      if(!items.length){
        el("historicoList").innerHTML = "<div class='histItem'><b>Nenhum registro.</b></div>";
        return;
      }
      el("historicoList").innerHTML = items.map(it=>{
        const la = (it.laudo || "APROVADO").toUpperCase();
        const icon = (la==="REPROVADO") ? "üî¥" : (la==="APONTAMENTO") ? "üü°" : "üü¢";
        const when = formatDate(it.createdAt);
        const title = `${icon} ${escapeHtml(it.modelo || "-")} ‚Äî ${escapeHtml(it.placa || "-")}`;
        const meta = `${escapeHtml(when)} ‚Ä¢ ${escapeHtml(it.createdByEmail || "")}`;
        return `
          <div class="histItem">
            <div class="histTop">
              <div>
                <div class="histTitle">${title}</div>
                <div class="histMeta">${meta}</div>
              </div>
              <div class="histMeta"><b>${escapeHtml(la)}</b></div>
            </div>
            <div class="histBtns">
              <button class="mini mOpen" data-open="${it.id}">Abrir</button>
              <button class="mini mCopy" data-copy="${it.id}">Copiar</button>
              <button class="mini mSend" data-send="${it.id}">Whats</button>
            </div>
          </div>
        `;
      }).join("");

      el("historicoList").querySelectorAll("[data-open]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-open");
          const it = items.find(x=>x.id===id);
          if(!it) return;
          el("preview").innerText = it.reportText || "";
          setTab("nova");
          window.scrollTo({top:0, behavior:"smooth"});
        });
      });

      el("historicoList").querySelectorAll("[data-copy]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-copy");
          const it = items.find(x=>x.id===id);
          if(!it) return;
          const ok = await copiarTexto(it.reportText || "");
          if(ok) alert("Relat√≥rio copiado!");
        });
      });

      el("historicoList").querySelectorAll("[data-send]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-send");
          const it = items.find(x=>x.id===id);
          if(!it) return;
          abrirWhats(it.reportText || "");
        });
      });

    }, (err)=>{
      el("historicoList").innerHTML = "<div class='histItem'><b>Erro ao carregar.</b><div class='histMeta'>" + escapeHtml(err?.message || err) + "</div></div>";
    });
  }

  // ===== Login actions =====
  el("btnDoLogin").addEventListener("click", async ()=>{
    const email = v("loginEmail");
    const pass  = v("loginPass");
    if(!email || !pass) return el("loginHint").innerHTML = "<span class='warn'>Preencha e-mail e senha.</span>";
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      isGuest = false;
      el("loginHint").innerHTML = "";
    }catch(e){
      el("loginHint").innerHTML = "<span class='warn'>Erro no login:</span> " + (e?.message || e);
    }
  });

  el("btnCreateUser").addEventListener("click", async ()=>{
    const email = v("loginEmail");
    const pass  = v("loginPass");
    if(!email || !pass) return el("loginHint").innerHTML = "<span class='warn'>Preencha e-mail e senha.</span>";
    if(pass.length < 6) return el("loginHint").innerHTML = "<span class='warn'>Senha m√≠nima: 6 caracteres.</span>";
    try{
      await createUserWithEmailAndPassword(auth, email, pass);
      isGuest = false;
      el("loginHint").innerHTML = "<span class='ok'>Usu√°rio cadastrado!</span>";
    }catch(e){
      el("loginHint").innerHTML = "<span class='warn'>Erro ao cadastrar:</span> " + (e?.message || e);
    }
  });

  el("btnGuest").addEventListener("click", ()=>{
    isGuest = true;
    try{ signOut(auth); }catch(e){}
    showApp();
    el("whoami").textContent = "Convidado";
    setTab("nova");
  });

  el("btnLogout").addEventListener("click", async ()=>{
    isGuest = false;
    try{ await signOut(auth); }catch(e){}
    showLogin();
  });

  el("btnSwitchUser").addEventListener("click", ()=>{
    isGuest = false;
    showLogin();
  });

  // ===== Buttons =====
  el("btnWhats").addEventListener("click", async ()=>{
    if(!validarObrigatorios()) return;
    const texto = montarRelatorio();
    await salvarNoFirestore(texto);
    abrirWhats(texto);
  });

  el("btnCopy").addEventListener("click", async ()=>{
    if(!validarObrigatorios()) return;
    const texto = montarRelatorio();
    await salvarNoFirestore(texto);
    const ok = await copiarTexto(texto);
    if(ok) alert("Relat√≥rio copiado!");
  });

  // ===== Input listeners =====
  const ids = [
    "modelo","ano","versao","placa","km","kmComprou",
    "fipe","valorPretendido",
    "laudo","laudoObs","leilao",
    "motor","luzes","ar",
    "volante","cambio","console",
    "bancosOnde","bancosAcao","bancosObs",
    "pecasPintura","farolE","farolD","lanternaE","lanternaD","pneus",
    "outros",
    "consultor","avaliadores",
    "cliente","local","captacao"
  ];
  ids.forEach(id=>{
    el(id).addEventListener("input", ()=>{
      if(id==="laudo"){ setStatusBadge(); toggleLaudoDescricao(); }
      atualizarPreview();
    });
    el(id).addEventListener("change", ()=>{
      if(id==="laudo"){ setStatusBadge(); toggleLaudoDescricao(); }
      atualizarPreview();
    });
  });

  // ===== Auth state =====
  onAuthStateChanged(auth, (u)=>{
    if(isGuest) return;
    if(u){
      showApp();
      el("whoami").textContent = lower(u.email || "");
      setTab("nova");
    }else{
      showLogin();
      el("whoami").textContent = "‚Äî";
    }
  });

  // Init
  setStatusBadge();
  toggleLaudoDescricao();
  atualizarPreview();
</script>

</body>
</html>